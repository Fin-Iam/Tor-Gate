version: '3.8'

services:
  flarum:
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile
      target: development
    volumes:
      - ..:/workspace:cached
      - ./config/nginx:/etc/nginx/http.d
      - ./config/php:/usr/local/etc/php/conf.d
      - ./config/supervisor:/etc/supervisor/conf.d
      - flarum-data:/var/www/flarum/storage
      - ./logs:/var/log
    ports:
      - "8080:80"
      - "8082:8082"  # Security gateway
    environment:
      - XDEBUG_MODE=develop,debug
      - XDEBUG_CONFIG=client_host=host.docker.internal
      - PHP_IDE_CONFIG=serverName=flarum-dev
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: /usr/local/bin/entrypoint.sh
  
  mariadb:
    environment:
      - MYSQL_ROOT_PASSWORD=root_secret_password
      - MYSQL_DATABASE=flarum
      - MYSQL_USER=flarum
      - MYSQL_PASSWORD=flarum_secret_password
    volumes:
      - mariadb-data:/var/lib/mysql
      - ./init-scripts:/docker-entrypoint-initdb.d
  
  redis:
    volumes:
      - redis-data:/data
  
  phpmyadmin:
    profiles: ["dev"]

volumes:
  flarum-data:
  mariadb-data:
  redis-data:
